<!doctype html>
<html lang="en">
	<head>
		<title>Cloudfort Dash</title>
		
		<meta name="description" content="">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<link rel="stylesheet" href="../../assets/css/style.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/agate.min.css">
		
		<link rel="icon" type="image/svg+xml" href="../../assets/images/favicon.svg">
	</head>

	<body>
		<div id="div-confirm-popup" class="card border popup popup-middle">
			<span id="span-confirm-popup-msg">are you sure?</span><br>
			<button class="btn" onclick="resolve_confirm(false)">no</button>
			<button class="btn" onclick="resolve_confirm(true)">yes</button>
		</div>
		
		<div id="div-notify-popup" class="card border popup popup-middle">
			<span id="span-notify-popup-msg">are you sure?</span><br>
			<button class="btn" onclick="resolve_notify()">ok</button>
		</div>
		
		<style>
			.popup {
				display: none;
				position: fixed;
				margin-left: auto;
				margin-right: auto;
				text-align: center;
				width: 500px; 
				max-width: 90%;
				z-index: 999;
			}
		
			.popup-middle {
				left: 0;
				right: 0;
				top: 25vh;
			}
		
			.popup-bottom {
				left: 0;
				right: 0;
				bottom: 0;
			}
		
			@media screen and (min-width: 600px) {
				.popup-dash {
					left: 3.5em;
					max-width: calc(90% - 3.5em);
				}
			}
		
		</style>
		
		<script>
			function sleep(ms) {
			    return new Promise(resolve => setTimeout(resolve, ms));
			}
		
			var confirm_resolved, confirm_result;
		
			async function resolve_confirm(res) {
				document.getElementById("div-confirm-popup").style.display = "none";
				document.getElementById("div-confirm-popup").style.boxShadow = "0px 0px 3px 1px var(--primary-grey)";
		
				confirm_result = res;
				confirm_resolved = true;
			}
		
			async function confirm_(msg) {
				confirm_resolved = false;
				document.getElementById("span-confirm-popup-msg").innerHTML = msg;
				document.getElementById("div-confirm-popup").style.display = "block";
		
				while(!confirm_resolved) {
					await sleep(250);
				}
		
				return confirm_result;
			}
		
			async function confirm_color(msg, col) {
				document.getElementById("div-confirm-popup").style.boxShadow = "0px 0px 3px 1px " + col;
		
				await confirm_(msg)
			}
		
			var notify_resolved;
		
			async function resolve_notify() {
				notify_resolved = true;
				document.getElementById("div-notify-popup").style.display = "none";
				document.getElementById("div-notify-popup").style.boxShadow = "0px 0px 3px 1px var(--primary-grey)";
			}
		
			async function notify(msg) {
				notify_resolved = false;
				document.getElementById("span-notify-popup-msg").innerHTML = msg;
				document.getElementById("div-notify-popup").style.display = "block";
		
				while(!notify_resolved) {
					await sleep(250);
				}
			}
		
			async function notify_color(msg, col) {
				document.getElementById("div-notify-popup").style.boxShadow = "0px 0px 3px 1px " + col;
		
				await notify(msg)
			}
		
			async function notify_resp(result) {
				await notify_color(result["response"], (result["successful"] ? "var(--primary-grey)" : "var(--primary-red)"));
			}
			
		</script>
		
		<div align="center">
			<div class="auth-page">
				<div class="card border" style="margin-top: 15vh; width: 350px; max-width: 90%;">
					<h3>Admin Login</h3>
			
					<table class="centered" style="width: 100%">
						<tr>
							<td>
								<input 
									id="input-admin-url"
									type="text"
									placeholder="admin url" 
									spellcheck="false"
								>
							</td>
						</tr>
						<tr>
							<td>
								<input 
									id="input-email"
									type="email"
									placeholder="email" 
									spellcheck="false"
								>
							</td>
						</tr>
						<tr>
							<td>
								<input 
									id="input-password"
									type="password"
									placeholder="password" 
									spellcheck="false"
								>
							</td>
						</tr>
						<tr>
							<td>
								<input 
									id="input-secret"
									type="password"
									placeholder="secret" 
									spellcheck="false"
								>
							</td>
						</tr>
					</table>
			
					<button class="btn" onclick="sign_in()" style="margin-top: 0.5em">sign in</button>
				</div>
			</div>
			
			<script src="../../assets/js/crypto-js/crypto-js.js"></script>
			<script type="text/javascript" src="../../assets/js/pocketbase.umd.js"></script>
			<script>
				var pb;
			
				function signature(msg) {
					return CryptoJS.HmacSHA256(msg, document.getElementById("input-secret").value);
				}
			
				async function sign_in() {
					const date = new Date().getTime().toString();
			
					const formData = new FormData();
					formData.append("date", date);
			
					let response = await fetch("/api/secret/check", {
						method: "POST",
						headers: {
							//"content-type": "application/json"
							"signature": signature(date)
					    },
				        body: formData
					});
					let result = await response.json();
			
					if(result["valid"] != true) {
						notify("invalid secret");
						return;
					}
					
					pb = new PocketBase(document.getElementById("input-admin-url").value);
			
					const authData = await pb.admins.authWithPassword(
				        document.getElementById("input-email").value,
				        document.getElementById("input-password").value,
				    ).then((response) => {
						if(response.error) {
							notify("sign in failed");
							console.log(response.error.message)
						}
						else {
							localStorage.setItem("pb-url", document.getElementById("input-admin-url").value);
							localStorage.setItem("CLOUDFORT_DASH_SECRET", document.getElementById("input-secret").value);
							window.location.href = "../../";
						}
					}).catch((err) => {
						notify("sign in failed");
						console.log(err);
					});
			
				    /*console.log(" isValid: " + pb.authStore.isValid);
				    console.log("   token: " + pb.authStore.token);
				    console.log("model.id: " + pb.authStore.model.id);*/
				}
			
				if(localStorage.getItem("pb-url")) {
					pb = new PocketBase(localStorage.getItem("pb-url"));
					if(pb.authStore.isValid) {
					    location.href = "../../"
					}
					else {
						document.getElementById("input-admin-url").value = localStorage.getItem("pb-url");
					}
				}
				else {
					document.getElementById("input-admin-url").value = window.location.protocol + "//" + window.location.hostname + ":8000";
				}
			
				document.addEventListener('keypress', (event) => {
				  var name = event.key;
				  var code = event.code;
			
				  if(name == 'Enter' || code == 'Enter')
				  	sign_in();
				}, false);
			</script>
		</div>

		<script type="text/javascript" src="../../assets/js/script.js"></script>
	</body>
</html>
