<div class="card">
	<i title="open" class='bs-ico bootstrap-folder-open width-1em ico-link-color' onclick="show_input_path_create()"></i> &nbsp;&nbsp;
	<i title="save" class='bs-ico bootstrap-save width-1em ico-link-color' onclick="save_file()"></i> &nbsp;&nbsp;
	<i title="goto line" class='bs-ico bootstrap-arrow-down-up width-1em ico-link-color' onclick="show_goto_line_no()"></i> &nbsp;&nbsp;
	<i title="close" class='bs-ico bootstrap-x-square width-1em ico-link-color' onclick="close_file()"></i>
</div><br>

<select id="select-highlight" onchange="select_highlight_event()" style="display: inline-flex; width: 100px">
	<option value="none" disabled hidden selected>highlight</option>
	<option value="true">yes</option>
	<option value="false">no</option>
</select><br>

<div id="card-input-path" class="card" style="display: none">
	<input id="input-path" placeholder="path">
	<button id="open_button" class="btn" onclick="open_file()" style="display: none">open</button>
</div>

<div id="card-input-line-no" class="card" style="display: none; width: 8em">
	<input id="input-line-no" placeholder="line" style="width: 4em">
	<button id="open_button" class="btn" onclick="jump_to_line()" style="display: inline">go</button>
</div>

<select id="select-open-file" onchange="select_open_file_event()">
	<option value="none" disabled hidden selected>open files</option>
</select><br>

<div id="editor-container" align="center">
<div id="editor-content" class="noselect" spellcheck="false" aria-hidden="true" onscroll="scroll_editor()"></div><textarea id="editor" title="line " class="" spellcheck="false" readonly oninput="redraw_editor()" onscroll="scroll_editor_content()" onclick="set_line_no()"></textarea></div><br>

<style>
/* for block of numbers */
.hljs-ln-numbers {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

    text-align: center;
    color: grey;
    vertical-align: top;
    border-right: 1px solid grey;
    padding-right: 0.5em !important;
    min-width: 2.5em !important;

    /* your custom style here */
}

/* for block of code */
.hljs-ln-code {
    padding-left: 0.5em !important;
}
</style>

<script>
	var open_path = "<nil>";
	const file_select = document.getElementById("select-open-file");
	const editor = document.getElementById("editor");
	var file_content = {};

	async function select_highlight_event() {
		highlight_editor = document.getElementById("select-highlight").value;
		document.getElementById("select-highlight").value = "none";
		redraw_editor();
	}

	async function select_open_file_event() {
		file_content[open_path] = editor.value;
		open_path = file_select.value;
		editor.value = file_content[open_path];
		redraw_editor();
	}

	async function show_goto_line_no() {
		if(document.getElementById("card-input-line-no").style.display == "none")
			document.getElementById("card-input-line-no").style.display = "block";
		else
			document.getElementById("card-input-line-no").style.display = "none";
	}

	async function show_input_path_create() {
		if(document.getElementById("card-input-path").style.display == "none") {
			var pwd = await get_pwd();

			if(pwd.substring(0, home.length) == home)
			    pwd = "~" + pwd.substring(home.length, pwd.length);

			document.getElementById("card-input-path").style.display = "flex";
			document.getElementById("open_button").style.display = "inline-flex";
			document.getElementById("input-path").value = pwd + "/";
			document.getElementById("input-path").focus();
		}
		else {
			document.getElementById("card-input-path").style.display = "none";
			document.getElementById("open_button").style.display = "none";
		}
	}

	async function open_file() {
		var path = document.getElementById("input-path").value;

		if(path[0] == '~' && home.length)
			path = home + path.substring(1, path.length);

		edit_file(path);
		document.getElementById("card-input-path").style.display = "none";
		document.getElementById("open_button").style.display = "none";
		editor.readOnly = false;
	}

	async function close_file() {
		delete file_content[open_path];

		for(var i=0; i<file_select.length; ++i) {
			if(file_select.options[i].value == open_path) {
				file_select.remove(i);

				if(i == 1 && file_select.length == 1) {
					editor.value = "";
					editor.readOnly = true;
					file_select.value = "none";
					open_path = "<nil>"
				}
				else {
					if(i == file_select.length)
						--i;
					
					file_select.value = open_path = file_select.options[i].value;
					editor.value = file_content[open_path];
				}
				redraw_editor();
			}
		}
	}

	async function edit_file(path) {
		show("editor");
		editor.readOnly = false;

		if(open_path != "<nil>")
			file_content[open_path] = document.getElementById("editor").value;
		open_path = path;

		if(file_content.hasOwnProperty(open_path) && file_content[open_path] != "") {
			file_select.value = open_path;
			document.getElementById("editor").value = file_content[open_path];
			redraw_editor();
		}
		else {
			const date = new Date().getTime().toString();
			const formData = new FormData();
			formData.append("date", date);
			formData.append("path", open_path);

			let response = await fetch("/api/file/read", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
			    	//"content-type": "application/x-www-form-urlencoded"
			    	"signature": signature(date)
			    },
		        body: formData
			});
			let result = await response.json();

			document.getElementById("editor").value = result["content"];
			redraw_editor();

			var opt = document.createElement('option');
		    opt.value = open_path;
		    if(open_path.substring(0, home.length) == home)
			    opt.innerHTML = "~" + open_path.substring(home.length, open_path.length);
			else
			    opt.innerHTML = open_path;
		    file_select.appendChild(opt);
		    file_select.value = open_path;
		}
	}

	async function save_file() {
		if(open_path == "") {
			alert("no file open");
			return;
		}

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", open_path);
		formData.append("content", editor.value);

		let response = await fetch("/api/file/write", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
		    	//"content-type": "application/x-www-form-urlencoded"
		    	"signature": signature(date)
		    },
	        body: formData
		});
		let result = await response.json();
	}
</script>

<style>
	#select-open-file {
		background: var(--secondary-dark);
		border: 1px solid var(--light-black);
		color: var(--white);
		min-width: 200px;
		max-width: 100%;
		width: 95%;

		margin: 0.5em 0;
		padding-left: 0;

		-ms-box-sizing:border-box;
		-moz-box-sizing:border-box;
		-webkit-box-sizing:border-box; 
		box-sizing:border-box;
	}

	#input-path {
		width: 400px;
		max-width: 90%;
	}
</style>