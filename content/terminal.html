<div id="dash-breadcrumb">
    <a onclick="show('index')">dash</a>/terminal
</div>

<div id="textarea-terminal" style="text-align: left; margin: 0.5em 0;"></div>
<input id="input-terminal" placeholder="cmd" onkeydown="terminal_keypress(event)"><br>
<select id="select-hist" onchange="hist_event()">
	<option value="none" disabled hidden selected>history</option>
</select>

<script>
	const hist_select = document.getElementById("select-hist");
	var prev_cmd, cmd, twd;
	var hist_no = 0;

	async function hist_event() {
		document.getElementById("input-terminal").value = hist_select.value;
		document.getElementById("input-terminal").focus();
		hist_select.value = "none";
	}

	function remove_backspaces(str)
	{
	    while(str.indexOf("\b") != -1)
	        str = str.replace(/.\x08/, "");
	    return str;
	}

	async function run_cmd() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);

		prev_cmd = cmd;
		cmd = document.getElementById("input-terminal").value;

		if(cmd.length && cmd[0] == ' ')
			cmd = cmd.slice(1);
		else if(cmd != prev_cmd) {
			var opt = document.createElement('option');
		    opt.value = cmd;
		    opt.innerHTML = cmd;
		    hist_select.appendChild(opt);
		    hist_no = hist_select.options.length;
		}

		document.getElementById("textarea-terminal").innerHTML += document.getElementById("input-terminal").value + "\n";
		document.getElementById("input-terminal").value = "";

		if(cmd.split(" ")[0] == "edit") {
			document.getElementById("textarea-terminal").innerHTML += "\n";
			var path = cmd.split(" ")[1];
			if(path[0] == '/' || path[0] == '~')
				edit_file(path);
			else
				edit_file(twd + "/" + cmd.split(" ")[1]);
		}
		else if(cmd.split(" ")[0] == "cd") {
			var dir = cmd.split(" ")[1];

			if(dir[0] == '~' && home.length)
				dir = home + dir.substring(1, dir.length);

			formData.append("command", "cd " + twd + "; " + cmd + " 2> /dev/null; pwd");

			let response = await fetch("/api/run", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
		        body: formData
			});
			let result = await response.json();

			var otwd = twd;
			twd = result["output"].replaceAll("\n", "");

			if(twd.substring(0, home.length) == home)
				twd = "~" + twd.substring(home.length, twd.length);

			if(twd == otwd && dir != "./") 
				document.getElementById("textarea-terminal").innerHTML += "cd: " + dir + ": no such directory\n\n";
			else
				document.getElementById("textarea-terminal").innerHTML += "\n";
		}
		else if(cmd.split(" ")[0] == "CD") {
			var dir = cmd.split(" ")[1];

			if(dir[0] == '~' && home.length)
				dir = home + dir.substring(1, dir.length);

			formData.append("dir", dir);

			let response = await fetch("/api/cd", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
		        body: formData
			});
			let result = await response.json();

			await get_pwd();
			twd = pwd;

			if(twd.substring(0, home.length) == home)
				twd = "~" + twd.substring(home.length, twd.length);

			document.getElementById("textarea-terminal").innerHTML += result["output"] + "\n";
		}
		else {
			try {
				formData.append("command", "cd " + twd + "; " + cmd);

				let response = await fetch("/api/run", {
					method: "POST",
					headers: {
						//"content-type": "application/json"
				    	//"content-type": "application/x-www-form-urlencoded"
				    	"signature": signature(date)
				    },
			        body: formData
				});
				let result = await response.json();

				document.getElementById("textarea-terminal").innerHTML += remove_backspaces(result["output"]) + "\n";
			}
			catch(error) {
				notify("error: " + error);
			}
		}

		document.getElementById("textarea-terminal").innerHTML += "<span style='color: var(--sorbet-pink)'>" + twd + "</span>$ ";
		document.getElementById("textarea-terminal").scrollTop = document.getElementById("textarea-terminal").scrollHeight;
	}

	async function terminal_init() {
		await get_pwd();
		twd = pwd;

		if(twd.substring(0, home.length) == home)
			twd = "~" + twd.substring(home.length, twd.length);

		document.getElementById("textarea-terminal").innerHTML += "<span style='color: var(--sorbet-pink)'>" + twd + "</span>$ ";
	}

	function terminal_keypress(e) {
		var name = e.key;
		var code = e.code;

		//alert(name)

		if(name == 'ArrowUp' || code == 'ArrowUp') {
			if(hist_no > 1) {
				document.getElementById("input-terminal").value = hist_select.options[--hist_no].value;
			}

			setTimeout(function(){ document.getElementById("input-terminal").selectionStart = document.getElementById("input-terminal").selectionEnd = 1000; }, 0);
		}
		else if(name == 'ArrowDown' || code == 'ArrowDown') {
			if(hist_no + 1 < hist_select.options.length) {
				document.getElementById("input-terminal").value = hist_select.options[++hist_no].value;

				setTimeout(function(){ document.getElementById("input-terminal").selectionStart = document.getElementById("input-terminal").selectionEnd = 1000; }, 0);
			}
			else if(hist_no < hist_select.options.length) {
				++hist_no;
				document.getElementById("input-terminal").value = "";
			}
		}
		else if(name == 'Enter' || code == 'Enter') {
	  		run_cmd();
		}
	}
</script>

<style>
	#textarea-terminal, #input-terminal, #select-hist {
		background: var(--secondary-dark);
		border: 1px solid var(--light-black);
		color: var(--white);
		font-family: "ubuntu mono";
		max-width: 100%; 
		width: 100%; 
		overflow-y: scroll;

		-ms-box-sizing:border-box;
		-moz-box-sizing:border-box;
		-webkit-box-sizing:border-box; 
		box-sizing:border-box;
	}

	#select-hist {
		margin-top: 0.5em;
		margin-left: 0;
		padding-left: 0;
	}

	#textarea-terminal {
		resize: none;
		height: calc(100vh - 8em); 
		white-space: pre-wrap;
	}
</style>