<div id="dash-breadcrumb">
    <a onclick="show('index')">dash</a>/terminal
</div>

<select id="select-terminal-interactive" class="noselect" style="margin: 0.25em 0 0; width: 300px">
	<option value="interactive" selected>interactive</option>
	<option value="non-interactive">non-interactive</option>
</select>
<div id="textarea-terminal" style="text-align: left; margin: 0.5em 0;"></div>
<input id="input-terminal" placeholder="cmd" spellcheck="false" onkeydown="terminal_keypress(event)"><br>
<select id="select-hist" class="noselect" onchange="hist_event()">
	<option value="none" disabled hidden selected>history</option>
</select>

<script>
	const hist_select = document.getElementById("select-hist");
	var prev_cmd, cmd, twd;
	var hist_no = 0;
	var finished = true;

	var socket = new WebSocket("ws://" + window.location.host + "/api/socket/run");

	function desanitize(str) {
	    str = str.replaceAll("\\n", "\n");

		var re = /\n.*\\r/g
		str = str.replaceAll(re, "\n");

		while(str.indexOf("\\b") != -1)
	        str = str.replace(/.\\b/, "");

	    return str;
	}

	function remove_backspaces(str)
	{
	    while(str.indexOf("\b") != -1)
	        str = str.replace(/.\x08/, "");
	    return str;
	}

	async function add_prompt() {
		if(document.getElementById("textarea-terminal").innerHTML != "")
			document.getElementById("textarea-terminal").innerHTML += "\n";
		document.getElementById("textarea-terminal").innerHTML += "<span style='color: var(--sorbet-pink)'>" + twd + "</span>$ ";
		document.getElementById("textarea-terminal").scrollTop = document.getElementById("textarea-terminal").scrollHeight;
	}

	socket.onmessage = function (e) {
		if(e.data == "[finished]") {
			finished = true;
			add_prompt();
		}
		else if(e.data == "invalid signature") {
			document.getElementById("input-terminal").disabled = true;
			document.getElementById("textarea-terminal").innerHTML = "websocket handshake failed";
		}
		else {
			document.getElementById("textarea-terminal").innerHTML += e.data;
			document.getElementById("textarea-terminal").innerHTML = desanitize(document.getElementById("textarea-terminal").innerHTML);
			document.getElementById("textarea-terminal").scrollTop = document.getElementById("textarea-terminal").scrollHeight;
		}
    };

	async function hist_event() {
		document.getElementById("input-terminal").value = hist_select.value;
		document.getElementById("input-terminal").focus();
		hist_select.value = "none";
	}

	async function run_cmd() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);

		prev_cmd = cmd;
		cmd = document.getElementById("input-terminal").value;

		if(cmd.length && cmd[0] == ' ')
			cmd = cmd.slice(1);
		else if(cmd.length && cmd != prev_cmd && finished) {
			var opt = document.createElement('option');
		    opt.value = cmd;
		    opt.innerHTML = cmd;
		    hist_select.appendChild(opt);
		}
		hist_no = hist_select.options.length;

		document.getElementById("textarea-terminal").innerHTML += document.getElementById("input-terminal").value + "\n";
		document.getElementById("input-terminal").value = "";

		if(cmd == "clear") {
			document.getElementById("textarea-terminal").innerHTML = "";

			add_prompt();
		}
		else if(cmd.split(" ")[0] == "edit") {
			var path = cmd.split(" ")[1];
			if(path[0] == '/' || path[0] == '~')
				edit_file(path);
			else
				edit_file(twd + "/" + cmd.split(" ")[1]);

			add_prompt();
		}
		else if(cmd.split(" ")[0] == "cd") {
			var dir = cmd.split(" ")[1];

			if(dir[0] == '~' && home.length)
				dir = home + dir.substring(1, dir.length);

			formData.append("command", "cd " + twd + "; " + cmd + " 2> /dev/null; pwd");

			let response = await fetch("/api/run", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
		        body: formData
			});
			let result = await response.json();

			var otwd = twd;
			twd = result["output"].replaceAll("\n", "");

			if(twd.substring(0, home.length) == home)
				twd = "~" + twd.substring(home.length, twd.length);

			if(twd == otwd && dir != "./" && dir != twd) 
				document.getElementById("textarea-terminal").innerHTML += "cd: " + dir + ": no such directory\n";

			add_prompt();
		}
		else if(cmd.split(" ")[0] == "CD") {
			var dir = cmd.split(" ")[1];

			if(dir[0] == '~' && home.length)
				dir = home + dir.substring(1, dir.length);

			formData.append("dir", dir);

			let response = await fetch("/api/cd", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
		        body: formData
			});
			let result = await response.json();

			await get_pwd();
			twd = pwd;

			if(twd.substring(0, home.length) == home)
				twd = "~" + twd.substring(home.length, twd.length);

			document.getElementById("textarea-terminal").innerHTML += result["output"];
			add_prompt();
		}
		else if(document.getElementById("select-terminal-interactive").value == "interactive") {
			if(!finished)
				socket.send(cmd);
			else {
				finished = false;
				socket.send("cd " + twd + "; " + cmd);
			}
		}
		else {
			try {
				formData.append("command", "cd " + twd + "; " + cmd);

				let response = await fetch("/api/run", {
					method: "POST",
					headers: {
						//"content-type": "application/json"
				    	//"content-type": "application/x-www-form-urlencoded"
				    	"signature": signature(date)
				    },
			        body: formData
				});
				let result = await response.json();

				document.getElementById("textarea-terminal").innerHTML += result["output"];
				document.getElementById("textarea-terminal").innerHTML = remove_backspaces(document.getElementById("textarea-terminal").innerHTML);
				add_prompt();
			}
			catch(error) {
				notify("error: " + error);
			}
		}
	}

	async function terminal_init() {
		twd = pwd;

		if(twd.substring(0, home.length) == home)
			twd = "~" + twd.substring(home.length, twd.length);

		//signature handshake
		var date = new Date().getTime().toString();
		socket.send(date);
		socket.send(signature(date));

		add_prompt();

		if(config["terminal"] && config["terminal"]["mode"] == "non-interactive") {
			document.getElementById("select-terminal-interactive").value = "non-interactive";
		}
	}

	async function terminal_keypress(e) {
		var name = e.key;
		var code = e.code;

		//alert(name)

		if(name == 'ArrowUp' || code == 'ArrowUp') {
			e.preventDefault();

			if(hist_no > 1) {
				document.getElementById("input-terminal").value = hist_select.options[--hist_no].value;
			}

			setTimeout(function(){ document.getElementById("input-terminal").selectionStart = document.getElementById("input-terminal").selectionEnd = 1000; }, 0);
		}
		else if(name == 'ArrowDown' || code == 'ArrowDown') {
			e.preventDefault();

			if(hist_no + 1 < hist_select.options.length) {
				document.getElementById("input-terminal").value = hist_select.options[++hist_no].value;

				setTimeout(function(){ document.getElementById("input-terminal").selectionStart = document.getElementById("input-terminal").selectionEnd = 1000; }, 0);
			}
			else if(hist_no < hist_select.options.length) {
				++hist_no;
				document.getElementById("input-terminal").value = "";
			}
		}
		else if(name == 'Enter' || code == 'Enter') {
			e.preventDefault();

	  		run_cmd();
		}
		else if(e.altKey) {
			if(e.key == 'c') {
				e.preventDefault();
				document.getElementById("textarea-terminal").innerHTML += "kill\n";
				socket.send("kill");
			}
		}
		else if(name == 'Tab') {
			e.preventDefault();

			var input = document.getElementById("input-terminal").value;
			var pos = document.getElementById("input-terminal").selectionStart;

			var pspace = input.lastIndexOf(' ', pos-1);;
			var pslash = input.lastIndexOf('/', pos);;

			var dir = "";
			if(pslash > pspace)
				dir = input.substring(pspace + 1, pslash + 1);
			else
				dir = twd;
			var str;
			if(pslash > pspace)
				str = input.substring(pslash + 1, pos);
			else
				str = input.substring(pspace + 1, pos);

			//alert("'" + dir + "'\n'" + str + "'");

			const date = new Date().getTime().toString();
			const formData = new FormData();
			formData.append("date", date);
			formData.append("dir", dir);
			formData.append("str", str);

			response = await fetch("/api/tab", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.json();

			var options = result["output"].split(" ");

			if(options.length == 1 && options[0] != "") {
				document.getElementById("input-terminal").value = input.substring(0, pos) + options[0].substring(str.length, options[0].length) + input.substring(pos, input.length);

				setTimeout(function(){document.getElementById("input-terminal").selectionStart = document.getElementById("input-terminal").selectionEnd = pos + options[0].length - str.length; }, 0);
			}
			else if(options.length > 1) {
				document.getElementById("textarea-terminal").innerHTML += document.getElementById("input-terminal").value + "\n";
				document.getElementById("textarea-terminal").innerHTML += result["output"] + "\n";
				add_prompt();
			}

			//alert(result["output"]);
		}
	}
</script>

<style>
	#textarea-terminal, #input-terminal, #select-hist {
		background: var(--secondary-dark);
		border: 1px solid var(--light-black);
		color: var(--white);
		font-family: "ubuntu mono";
		max-width: 100%; 
		width: 100%; 
		overflow-y: scroll;

		-ms-box-sizing:border-box;
		-moz-box-sizing:border-box;
		-webkit-box-sizing:border-box; 
		box-sizing:border-box;
	}

	#select-terminal-interactive {
		background: var(--secondary-dark);
		border: 1px solid var(--light-black);
		color: var(--white);
		font-family: "ubuntu mono";
	}

	#select-hist {
		margin-top: 0.5em;
		margin-left: 0;
		padding-left: 0;
	}

	#textarea-terminal {
		resize: none;
		height: calc(100vh - 9.5em); 
		white-space: pre-wrap;
	}
</style>