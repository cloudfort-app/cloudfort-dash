<div id="dash-breadcrumb">
    <a onclick="show('index')">dash</a>/explorer
</div>

<div class="card border">
	<span id="span-pwd"></span>
</div><br>

<div class="card border noselect" style="overflow-x: scroll; white-space: nowrap; max-width: 90%;">
	<i title="root" class='bs-ico bootstrap-slash ico-link-color' onclick="get_dir('')"></i> &nbsp;
	<i title="home" class='bs-ico bootstrap-house ico-link-color' onclick="get_dir(home)"></i> &nbsp;&nbsp;
	<i title="explore" class='bs-ico bootstrap-folder ico-link-color' onclick="show_browse_dir(home)"></i> &nbsp;&nbsp;
	<i title="back" class='bs-ico bootstrap-arrow-left ico-link-color' onclick="explorer_back()"></i> &nbsp;&nbsp;
	<i title="forward" class='bs-ico bootstrap-arrow-right ico-link-color' onclick="explorer_forward()"></i> &nbsp;&nbsp;
	<i title="refresh" class='bs-ico bootstrap-arrow-repeat ico-link-color' onclick="get_dir(bwd)"></i> &nbsp;&nbsp;
	<i title="new directory" class='bs-ico bootstrap-folder-plus ico-link-color' onclick="show_create_dir()"></i> &nbsp;&nbsp;
	<i title="new file" class='bs-ico bootstrap-file-earmark-plus ico-link-color' onclick="show_create_file()"></i> &nbsp;&nbsp;
	<i title="edit" class='bs-ico bootstrap-code-square ico-link-color' onclick="edit_selected_files()"></i> &nbsp;&nbsp;
	<i title="open in terminal" class='bs-ico bootstrap-terminal ico-link-color' onclick="open_in_terminal()"></i> &nbsp;&nbsp;
	<i title="run" class='bs-ico bootstrap-alt ico-link-color' onclick="show_run_cmd()"></i> &nbsp;&nbsp;
	<i title="compress" class='bs-ico bootstrap-box ico-link-color' onclick="show_compress_file()"></i> &nbsp;&nbsp;
	<i title="extract" class='bs-ico bootstrap-file-zip ico-link-color' onclick="extract_paths()"></i> &nbsp;&nbsp;
	<i title="upload" class='bs-ico bootstrap-cloud-arrow-up ico-link-color' onclick="show_upload_file()"></i> &nbsp;&nbsp;
	<i title="url" class='bs-ico bootstrap-cloud-arrow-down ico-link-color' onclick="show_fetch_url()"></i> &nbsp;&nbsp;
	<i title="download" class='bs-ico bootstrap-download ico-link-color' onclick="download_files()"></i> &nbsp;&nbsp;
	<i title="copy/move" class='bs-ico bootstrap-box-arrow-right ico-link-color' onclick="show_mv_paths()"></i> &nbsp;&nbsp;
	<i title="rename" class='bs-ico bootstrap-input-cursor-text ico-link-color' onclick="show_rename_path()"></i> &nbsp;&nbsp;
	<i title="delete" class='bs-ico bootstrap-trash ico-link-color' onclick="rm_paths()"></i>
</div><br>

<div id="card-browse-dir" class="card border" style="display: none">
	<input id="input-explorer-browse-dir" placeholder="dir" style="width: 400px; max-width: 90%">
	<button class="btn" onclick="explorer_browse_dir()">explore</button>
</div>

<div id="download-popup" class="card card-shadow-no-hover popup popup-dash popup-middle" style="width: 400px">
	<table id="table-downloads">
	</table><br>

	<button class="btn" onclick="document.getElementById('download-popup').style.display = 'none'" style="width: 100px; margin: 0 auto">close</button>
</div>

<div id="serve-img-popup" class="card card-shadow-no-hover popup popup-dash popup-top" style="width: 90%; max-height: 95vh; margin-top: 2.5em; overflow-x: scroll">
	<img id="img-serve" style="min-width: 200px; max-height: 80vh; vertical-align: middle; margin-bottom: 1em;"><br>

	<button class="btn" onclick="document.getElementById('serve-img-popup').style.display = 'none'" style="width: 100px; margin: 0 auto">close</button>
	<a id="serve-img-download-btn"><button class="btn" style="width: 100px; margin: 0 auto">download</button></a>
</div>

<div id="serve-video-popup" class="card card-shadow-no-hover popup popup-dash popup-top" style="width: 100%; height: 100%">
	<video id="video-serve" controls loop playsinline style="width: 100%; height: 93%"><source id="serve-video-source" type="video/mp4"></video><br>

	<button class="btn" onclick="document.getElementById('video-serve').pause(); document.getElementById('serve-video-popup').style.display = 'none'" style="width: 100px; margin: 0 auto">close</button>
	<a id="serve-video-download-btn"><button class="btn" style="width: 100px; margin: 0 auto">download</button></a>
</div>

<div id="card-fetch-url" class="card border" style="display: none">
	<input id="input-fetch-url" placeholder="url" style="width: 300px; max-width: 90%;">
	<button class="btn" onclick="fetch_url()">fetch</button>
</div>

<div id="card-run-cmd" class="card border" style="display: none">
	<input id="input-explorer-cmd" placeholder="cmd" style="width: 400px; max-width: 90%">
	<button class="btn" onclick="explorer_run_cmd()">run</button>
</div>

<div id="card-input-name" class="card border" style="display: none">
	<input id="input-name" placeholder="name">
	<button id="create_dir_button"  class="btn" onclick="create_dir()" style="display: none">create</button>
	<button id="create_file_button" class="btn" onclick="create_file()" style="display: none">create</button>
</div>

<div id="card-input-compress" class="card border" style="display: none">
	<input id="input-name-compress" placeholder="name" style="width:200px">
	<select id="select-compress" style="margin: 0.25em; width: 75px">
		<option value=".tar.xz" selected>.tar.xz</option>
		<option value=".tar.gz">.tar.gz</option>
		<option value=".tar.bz2">.tar.bz2</option>
		<option value=".zip">.zip</option>
	</select>
	<button  class="btn" onclick="compress_paths()">compress</button>
</div>

<div id="card-input-upload" class="card border" style="display: none">
	<div class="dropzone">
		<div id="span-dropzone" style="padding: 0.25em 0; overflow-x: hidden; white-space: nowrap; font-size: 1em">drop or select</div>
		<input id="input-file" type="file" multiple="multiple" class="upload-input" onchange="display_filename()" />
	</div>
	<button id="upload_button"  class="btn" onclick="upload_file()">upload</button>
</div>

<div id="card-input-rename" class="card border" style="display: none">
	<input id="input-name-current" placeholder="current path" style="width: 300px"><br>
	<input id="input-name-new" placeholder="new path" style="width: 300px"><br>
	<button id="duplicate_path_button"  class="btn" onclick="duplicate_path()">duplicate</button>
	<button id="rename_path_button"  class="btn" onclick="rename_path()">rename</button>
</div>

<div id="card-input-mv" class="card border" style="display: none">
	<input id="input-mv-path" placeholder="path">
	<button  class="btn" onclick="cp_paths()">copy</button>
	<button  class="btn" onclick="mv_paths()">move</button>
</div>

<div class="card border" id="card-browser" style="max-width: 90%; margin-bottom: 1em;">
	<table id="table-files" style="white-space: nowrap">
		<tr>
			<th><input type='checkbox' id='checkbox-all' onchange='select_all_event()' style='vertical-align: middle;'></th>
			<th></th>
			<th onclick='toggle_sort(1)' style="margin-right:100px; cursor: pointer;">name</th>
			<th onclick='toggle_sort(2)' style="cursor: pointer;">size</th>
			<th onclick='toggle_sort(3)' style="cursor: pointer;">modified</th>
		</tr>
	</table>
</div>

<style>
	input[type=checkbox] {
		position: relative;
		cursor: pointer;
    }
    input[type=checkbox]:before {
		content: "";
		display: block;
		position: absolute;
		width: 12px;
		height: 12px;
		top: 0;
		left: 2px;
		border: 1px solid grey;
		border-radius: 4px;
		background-color: var(--secondary-dark);
	}
    input[type=checkbox]:checked:after {
		content: "";
		display: block;
		width: 3px;
		height: 8px;
		border: solid white;
		border-width: 0 2px 2px 0;
		-webkit-transform: rotate(45deg);
		-ms-transform: rotate(45deg);
		transform: rotate(45deg);
		position: absolute;
		top: 0px;
		left: 6px;
	}

	.dropzone {
		margin-top: 0.15em;
		width: 300px;
		height: 30px;
		border: 1px dashed #999;
		border-radius: 3px;
		text-align: center;
	}

	.upload-icon {
		vertical-align: middle;
	}

	.upload-input {
		cursor: pointer;
		position: relative;
		top: -28px;
		left: 0;
		width: 100%;
		height: 30px;
		opacity: 0;
	}

	#table-files, #table-downloads {
		margin: 0 auto; 
		text-align: left;

		display: block;
		overflow-x: scroll;
		max-height: calc(100vh - 14.5em);
		overflow-y: scroll;
	}

	#card-browser {
		/*height: calc(100vh - 14em);*/
	}
</style>

<script>
	const files_table = document.getElementById("table-files");
	var bwd = "nil"; //browser working directory
	var bwd_hist = [];
	var hist_c = -1;
	var explorer_files;
	var file_no;

	var sort_indx = 1;
	var sort_dir = 1;

	async function select_all_event() {
		//document.getElementById('checkbox-parent').checked = document.getElementById('checkbox-all').checked;
		for(var f=0; f<explorer_files.length; ++f) {
			document.getElementById('checkbox-' + f).checked = document.getElementById('checkbox-all').checked;
		}
	}

	async function hide_input_cards() {
		document.getElementById("card-browse-dir").style.display = "none";
		document.getElementById("card-fetch-url").style.display = "none";
		document.getElementById("card-run-cmd").style.display = "none";
		document.getElementById("card-input-upload").style.display = "none";
		document.getElementById("card-input-mv").style.display = "none";
		document.getElementById("card-input-rename").style.display = "none";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("card-input-compress").style.display = "none";
		document.getElementById("create_dir_button").style.display = "none";
		document.getElementById("create_file_button").style.display = "none";
	}

	async function show_browse_dir() {
		if(document.getElementById("card-browse-dir").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-browse-dir").style.display = "block";
			document.getElementById("input-explorer-browse-dir").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_fetch_url() {
		if(document.getElementById("card-fetch-url").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-fetch-url").style.display = "block";
			document.getElementById("input-fetch-url").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_run_cmd() {
		if(document.getElementById("card-run-cmd").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-run-cmd").style.display = "block";
			document.getElementById("input-explorer-cmd").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_create_dir() {
		if(document.getElementById("create_dir_button").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-name").style.display = "block";
			document.getElementById("create_dir_button").style.display = "inline-flex";
			document.getElementById("input-name").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_create_file() {
		if(document.getElementById("create_file_button").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-name").style.display = "block";
			document.getElementById("create_file_button").style.display = "inline-flex";
			document.getElementById("input-name").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_compress_file() {
		if(document.getElementById("card-input-compress").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-compress").style.display = "block";
			document.getElementById("input-name-compress").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_upload_file() {
		if(document.getElementById("card-input-upload").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-upload").style.display = "block";
		}
		else {
			hide_input_cards();
		}
	}

	async function display_filename() {
		const fileField = document.getElementById("input-file");

		if(fileField.files.length > 1) 
			document.getElementById("span-dropzone").innerHTML = fileField.files.length + " files selected";
		else
			document.getElementById("span-dropzone").innerHTML = document.getElementById("input-file").value.split('\\').pop();
	}

	async function show_rename_path() {
		if(document.getElementById("card-input-rename").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-rename").style.display = "block";
			document.getElementById("input-name-current").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_mv_paths() {
		if(document.getElementById("card-input-mv").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-mv").style.display = "block";
			document.getElementById("input-mv-path").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function explorer_browse_dir() {
		document.getElementById("card-browse-dir").style.display = "none";
		get_dir(document.getElementById("input-explorer-browse-dir").value);
		document.getElementById("input-explorer-browse-dir").value = "";
	}

	async function create_dir() {
		var dirname = document.getElementById("input-name").value;

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + dirname);

		response = await fetch("/api/dir/create", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.text();

		get_dir(bwd);

		document.getElementById("input-name").value = "";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("create_dir_button").style.display = "none";
	}

	async function create_file() {
		var filename = document.getElementById("input-name").value;

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + filename);

		response = await fetch("/api/file/create", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.text();

		get_dir(bwd);

		document.getElementById("input-name").value = "";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("create_file_button").style.display = "none";
	}

	async function edit_selected_files() {
		var paths = "";
		var count = 0;
		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				if(explorer_files[f][0]) {
					await notify("cannot edit directories");
				}
				else {
					++count;
					await edit_file(bwd + "/" + explorer_files[f][1]);
				}
			}
		}

		if(!count) {
			notify("nothing selected")
		}
	}

	async function extract_path(path) {
		if(await confirm_("extract file?")) {
			const date = new Date().getTime().toString();
			const formData = new FormData();
			formData.append("date", date);

			var ext = path.substring(path.indexOf('.'), path.length);

			if(ext == ".zip") 
				formData.append("command", "cd " + bwd + "; unzip " + path);
			else 
				formData.append("command", "cd " + bwd + "; tar -xf " + path);

			response = await fetch("/api/run", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.text();

			if(result != "") {
				await notify(result.replaceAll("\n", "<br>"));
			}
		}

		get_dir(bwd);
	}

	async function extract_paths() {
		var paths = "";
		var count = 0;
		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				++count;
				var ext = explorer_files[f][1].substring(explorer_files[f][1].indexOf('.'), explorer_files[f][1].length);

				const date = new Date().getTime().toString();
				const formData = new FormData();
				formData.append("date", date);

				if(ext == ".zip") 
					formData.append("command", "cd " + bwd + "; unzip " + explorer_files[f][1]);
				else 
					formData.append("command", "cd " + bwd + "; tar -xf " + explorer_files[f][1]);

				response = await fetch("/api/run", {
					method: "POST",
					headers: {
						//"content-type": "application/json"
						"signature": signature(date)
				    },
					body: formData
				});
				result = await response.text();

				if(result != "") {
					notify(result.replaceAll("\n", "<br>"));
				}
			}
		}

		if(!count) {
			notify("nothing selected")
		}

		get_dir(bwd);
	}

	async function compress_paths() {
		var paths = "";
		var first = true;
		var count = 0;
		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				if(first)
					first = false;
				else
					paths += " ";
				paths += explorer_files[f][1];
				document.getElementById('checkbox-' + f).checked = false;
				++count;
			}
		}

		if(count) {
			const date = new Date().getTime().toString();
			const formData = new FormData();
			formData.append("date", date);
			//https://stackoverflow.com/a/27785347
			if(document.getElementById("select-compress").value == ".tar.xz") {
				formData.append("command", "tar -C " + bwd + "/ -c " + paths + " | xz > " + bwd + "/" + document.getElementById("input-name-compress").value + ".tar.xz");
			}
			else if(document.getElementById("select-compress").value == ".tar.gz") {
				formData.append("command", "tar -czf " + bwd + "/" + document.getElementById("input-name-compress").value + document.getElementById("select-compress").value + " -C " + bwd + "/ "  + paths);
			}
			else if(document.getElementById("select-compress").value == ".tar.bz2") {
				formData.append("command", "tar -C " + bwd + "/ -c " + paths + " | bzip2 > " + bwd + "/" + document.getElementById("input-name-compress").value + ".tar.bz2");
			}
			else if(document.getElementById("select-compress").value == ".zip") {
				formData.append("command", "cd " + bwd + "; zip -r " + bwd + "/" + document.getElementById("input-name-compress").value + ".zip " + paths);
			}

			response = await fetch("/api/run", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.text();

			get_dir(bwd);
		}
		else {
			notify("nothing selected")
		}

		document.getElementById("input-mv-path").value = "";
		document.getElementById("card-input-mv").style.display = "none";
	}

	async function upload_file() {
		const fileField = document.getElementById("input-file");

		if(!fileField.files.length) {
			notify("No files chosen");
			return;
		}

		for(var i=0; i<fileField.files.length; i++) {
			//waiting_popup("uploading " + fileField.value.split('\\').pop());
			waiting_popup("uploading " + fileField.files.item(i).name);

			const date = new Date().getTime().toString();
			const formData = new FormData();
			formData.append("date", date);
			//formData.append("path", bwd + "/" + fileField.value.split('\\').pop());
			formData.append("path", bwd + "/" + fileField.files.item(i).name);
			formData.append("file", fileField.files[i]);

			response = await fetch("/api/upload", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.text();

			if(result != "upload successful")
				await notify(result);

			resolve_waiting_popup();
		}

		get_dir(bwd);

		document.getElementById("card-input-upload").style.display = "none";
	}

	async function fetch_url() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		//formData.append("command", "wget -q -O " + bwd + "/" + document.getElementById("input-fetch-url").value.split('?')[0].split('/').pop() + " " + document.getElementById("input-fetch-url").value);
		formData.append("command", "cd " + bwd + "; wget " + document.getElementById("input-fetch-url").value);

		waiting_popup("downloading " + document.getElementById("input-fetch-url").value);

		response = await fetch("/api/run", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.text();

		resolve_waiting_popup();

		get_dir(bwd);

		document.getElementById("input-fetch-url").value = "";
		document.getElementById("card-fetch-url").style.display = "none";
	}

	async function open_in_terminal() {
		twd = bwd;
		document.getElementById("textarea-terminal").innerHTML += "\n";
		add_prompt();
		show('terminal');
	}

	async function explorer_run_cmd() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("command", "cd " + bwd + "; " + document.getElementById("input-explorer-cmd").value);


		waiting_popup(document.getElementById("input-explorer-cmd").value);

		response = await fetch("/api/run", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.text();

		resolve_waiting_popup();
		get_dir(bwd);

		document.getElementById("input-explorer-cmd").value = "";
		document.getElementById("card-run-cmd").style.display = "none";

		if(result != "") {
			await mono_notify(result);
		}
	}

	async function clear_downloads_table() {
		const downloads_table = document.getElementById("table-downloads");

		while(downloads_table.rows.length > 0)
			downloads_table.deleteRow(0);
	}

	async function download_files() {
		const downloads_table = document.getElementById("table-downloads");
		var r = 0;

		clear_downloads_table();

		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				if(explorer_files[f][0]) {
					await notify("cannot download directories");
				}
				else {
					const date = new Date().getTime().toString();
					const formData = new FormData();
					formData.append("date", date);
					formData.append("path", bwd + "/" + explorer_files[f][1]);

					response = await fetch("/api/download", {
						method: "POST",
						headers: {
							//"content-type": "application/json"
							"signature": signature(date)
					    },
						body: formData
					});
					var blob = await response.blob();

					var file = window.URL.createObjectURL(blob);

					var row = downloads_table.insertRow(0);
					row.insertCell(0).innerHTML = explorer_files[f][1];
					row.insertCell(1).innerHTML = "<a id='download-link-" + f + "' download><button class='btn'>download</button></a>";
					document.getElementById("download-link-"+ f).href = file;
					document.getElementById("download-link-"+ f).download = explorer_files[f][1];
					document.getElementById("download-link-"+ f).click();
					
	    			//window.location.assign(file);
				}
			}
		}
	}

	function is_img_ext(ext) {
		return (ext == ".png" || ext == ".jpg" || ext == ".jpeg" || ext == ".webp" || ext == ".svg" || ext == ".gif");
	}

	function is_video_ext(ext) {
		return (ext == ".mp4" || ext == ".ogg" || ext == ".webm");
	}

	function is_archive_ext(ext) {
		return (ext == ".zip" || ext == ".xz" || ext == ".bz2" || ext == ".gz");
	}

	async function serve_image(f) {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + explorer_files[f][1]);

		response = await fetch("/api/download", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		var blob = await response.blob();

		var file = window.URL.createObjectURL(blob);
		//window.location.assign(file);

		document.getElementById("serve-img-download-btn").href = file;
		document.getElementById("serve-img-download-btn").download = explorer_files[f][1];
		file_no = f;

		document.getElementById('img-serve').src = file;
		document.getElementById('img-serve').title = explorer_files[f][1];
		document.getElementById('serve-img-popup').style.display = "block";
	}

	async function serve_image_increment() {
		var f = file_no;
		f = (f+1)%explorer_files.length;
		while(f != file_no) {
			var ext = explorer_files[f][1].substring(explorer_files[f][1].indexOf('.'), explorer_files[f][1].length);
			if(is_img_ext(ext)) {
				serve_image(f);
				break;
			}
			f = (f+1)%explorer_files.length;
		}
	}

	async function serve_image_decrement() {
		var f = file_no;
		f--;
		if(f < 0)
			f = explorer_files.length-1;
		while(f != file_no) {
			var ext = explorer_files[f][1].substring(explorer_files[f][1].indexOf('.'), explorer_files[f][1].length);
			if(is_img_ext(ext)) {
				serve_image(f);
				break;
			}
			f--;
			if(f < 0)
				f = explorer_files.length-1;
		}
	}

	async function serve_video(f) {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + explorer_files[f][1]);

		response = await fetch("/api/download", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		var blob = await response.blob();

		var file = window.URL.createObjectURL(blob);
		//window.location.assign(file);

		document.getElementById('serve-video-popup').style.display = "block";

		var ext = explorer_files[f][1].substring(explorer_files[f][1].indexOf('.'), explorer_files[f][1].length);
		if(ext == ".mp4")
			document.getElementById('serve-video-source').type = "video/mp4";
		else if(ext == ".ogg")
			document.getElementById('serve-video-source').type = "video/ogg";
		else if(ext == ".webm")
			document.getElementById('serve-video-source').type = "video/webm";
		document.getElementById('video-serve').src = file;
		document.getElementById('video-serve').title = explorer_files[f][1];
		document.getElementById('video-serve').play();

		document.getElementById("serve-video-download-btn").href = file;
		document.getElementById("serve-video-download-btn").download = explorer_files[f][1];
		file_no = f;
	}

	async function serve_video_increment() {
		var f = file_no;
		f = (f+1)%explorer_files.length;
		while(f != file_no) {
			var ext = explorer_files[f][1].substring(explorer_files[f][1].indexOf('.'), explorer_files[f][1].length);
			if(is_video_ext(ext)) {
				serve_video(f);
				break;
			}

			f = (f+1)%explorer_files.length;
		}
	}

	async function serve_video_decrement() {
		var f = file_no;
		f--;
		if(f < 0)
			f = explorer_files.length-1;
		while(f != file_no) {
			var ext = explorer_files[f][1].substring(explorer_files[f][1].indexOf('.'), explorer_files[f][1].length);
			if(is_video_ext(ext)) {
				serve_video(f);
				break;
			}

			f--;
			if(f < 0)
				f = explorer_files.length-1;
		}
	}

	async function rename_path() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path-old", bwd + "/" + document.getElementById("input-name-current").value);
		formData.append("path-new", bwd + "/" + document.getElementById("input-name-new").value);

		response = await fetch("/api/rename", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.text();

		get_dir(bwd);

		document.getElementById("input-name-current").value = "";
		document.getElementById("input-name-new").value = "";
		document.getElementById("card-input-rename").style.display = "none";
	}

	async function duplicate_path() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("command", "cd " + bwd + "; cp -rf \"" + document.getElementById("input-name-current").value + "\" \"" + document.getElementById("input-name-new").value + "\"");

		response = await fetch("/api/run", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.text();

		get_dir(bwd);

		document.getElementById("input-name-current").value = "";
		document.getElementById("input-name-new").value = "";
		document.getElementById("card-input-rename").style.display = "none";
	}

	async function mv_paths() {
		var count = 0;
		const formData = new FormData();

		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				formData.append("path-" + count++, bwd + "/" + explorer_files[f][1])
				document.getElementById('checkbox-' + f).checked = false;
			}
		}

		if(count) {
			const date = new Date().getTime().toString();
			formData.append("date", date);
			formData.append("no-paths", count);
			formData.append("path", bwd + "/" + document.getElementById("input-mv-path").value);

			response = await fetch("/api/mv", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.text();

			get_dir(bwd);
		}
		else {
			notify("nothing selected")
		}

		document.getElementById("input-mv-path").value = "";
		document.getElementById("card-input-mv").style.display = "none";
	}

	async function cp_paths() {
		var paths = "";
		var first = true;
		var count = 0;
		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				if(first)
					first = false;
				else
					paths += " ";
				paths += "\"" + bwd + "/" + explorer_files[f][1] + "\"";
				document.getElementById('checkbox-' + f).checked = false;
				++count;
			}
		}

		if(count) {
			const date = new Date().getTime().toString();
			const formData = new FormData();
			formData.append("date", date);
			formData.append("command", "cp -rf " + paths + " \"" + bwd + "/" + document.getElementById("input-mv-path").value + "\"");

			response = await fetch("/api/run", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.text();

			get_dir(bwd);
		}
		else {
			notify("nothing selected")
		}

		document.getElementById("input-mv-path").value = "";
		document.getElementById("card-input-mv").style.display = "none";
	}

	async function rm_paths() {
		if(!await confirm_("permanently delete files?")) {
			return;
		}

		var count = 0;
		const formData = new FormData();

		for(var f=0; f<explorer_files.length; ++f) {
			if(document.getElementById('checkbox-' + f).checked) {
				formData.append("path-" + count++, bwd + "/" + explorer_files[f][1]);
				document.getElementById('checkbox-' + f).checked = false;
			}
		}

		if(count) {
			const date = new Date().getTime().toString();
			formData.append("date", date);
			formData.append("no-paths", count);

			response = await fetch("/api/rm", {
				method: "POST",
				headers: {
					//"content-type": "application/json"
					"signature": signature(date)
			    },
				body: formData
			});
			result = await response.text();

			get_dir(bwd);
		}
		else {
			notify("nothing selected")
		}
	}

	async function clear_explorer_table() {
		while(files_table.rows.length > 1)
			files_table.deleteRow(1);
	}

	function sort_data()
	{
		if(sort_indx == 1 || sort_indx == 3)
		{
			explorer_files.sort(function(obj1, obj2) {
				if(obj1[sort_indx].toLowerCase() > obj2[sort_indx].toLowerCase())
					return sort_dir*1;
				else if(obj1[sort_indx] == obj2[sort_indx])
					return 0;
				else return sort_dir*-1;
			});
		}
		else
		{
			explorer_files.sort(function(obj1, obj2) {
				return sort_dir*(obj1[sort_indx] - obj2[sort_indx]);
			});
		}

		//draw_table();
	}

	function toggle_sort(indx)
	{
		if(sort_indx == indx)
			sort_dir *= -1;
		else
		{
			sort_indx = indx;
			sort_dir = 1;
		}

		get_dir(bwd);
	}

	async function explorer_back() {
		if(hist_c > 0) {
			explore_dir(bwd_hist[--hist_c]);
		}
	}

	async function explorer_forward() {
		if(hist_c+1 < bwd_hist.length) {
			explore_dir(bwd_hist[++hist_c]);
		}
	}

	async function get_dir(dir) {
		if(dir != bwd) {
			if(hist_c+1 < bwd_hist.length)
				for(var i=hist_c; i<bwd_hist.length; ++i)
					bwd_hist.pop();

			bwd_hist.push(dir);
			hist_c = bwd_hist.length-1;
		}
		explore_dir(dir);
	}

	async function explore_dir(dir) {
		clear_explorer_table();

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);

		bwd = dir;
		document.getElementById("span-pwd").innerHTML = "";
		var dirs = [], files = [];

		var cwd = bwd;
		if(cwd.substring(0, home.length) == home)
			    cwd = "~" + cwd.substring(home.length, cwd.length);

		while(cwd.lastIndexOf("/") >= 0) {
			dirs.push(cwd);
			files.push(cwd.substring(cwd.lastIndexOf('/')+1, cwd.length+1))
			//alert(cwd);
			//alert(cwd.substring(cwd.lastIndexOf('/')+1, cwd.length+1))
			cwd = cwd.substring(0, cwd.lastIndexOf('/'))
		}

		if(cwd == '~')
			document.getElementById("span-pwd").innerHTML += "<a onclick='get_dir(\"" + home + "\")'>~</a>/"
		else
			document.getElementById("span-pwd").innerHTML += "/"

		for(var i=dirs.length-1; i>=0; --i) {
			document.getElementById("span-pwd").innerHTML += "<a onclick='get_dir(\"" + dirs[i].replace("~", home) + "\")'>" + files[i] + "</a>/"
		}

		if(dir[0] == '~' && home.length)
			dir = home + dir.substring(1, dir.length);
		else if(dir == "")
			dir = "/";

		formData.append("dir", dir);
		response = await fetch("/api/ls", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
	        body: formData
		});
		result = await response.json();
		explorer_files = result["files"];

		//sorts files
		sort_data();

		for(var f=result["files"].length-1; f>=0; --f) {
			var row = files_table.insertRow(1);

			var ext = result["files"][f][1].substring(result["files"][f][1].lastIndexOf('.'), result["files"][f][1].length).toLowerCase();

			row.insertCell(0).innerHTML = "<input type='checkbox' id='checkbox-" + f + "' style='vertical-align: middle;'>"

			if(result["files"][f][0])
				row.insertCell(1).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-folder no-hover-ico' style='padding-top: 3px'></i>";
			else {
				if(is_img_ext(ext))
					row.insertCell(1).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-file-earmark-image no-hover-ico' style='padding-top: 3px'></i>";
				else if(is_video_ext(ext))
					row.insertCell(1).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-film no-hover-ico' style='padding-top: 3px'></i>";
				else if(is_archive_ext(ext))
					row.insertCell(1).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-file-zip no-hover-ico' style='padding-top: 3px'></i>";
				else
					row.insertCell(1).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-file-earmark no-hover-ico' style='padding-top: 3px'></i>";
			}

			if(result["files"][f][0]) {
				row.insertCell(2).innerHTML = "<a onclick='get_dir(\"" + bwd + "/" + result["files"][f][1] +  "\")'>" + result["files"][f][1] + "/</a>";
			}
			else {
				if(is_img_ext(ext))
					row.insertCell(2).innerHTML = "<a onclick='serve_image(" + f + ")'>" + result["files"][f][1] + "</a>";
				else if(is_video_ext(ext))
					row.insertCell(2).innerHTML = "<a onclick='serve_video(" + f + ")'>" + result["files"][f][1] + "</a>";
				else if(is_archive_ext(ext))
					row.insertCell(2).innerHTML = "<a onclick='extract_path(\"" + bwd + "/" + result["files"][f][1] +  "\")'>" + result["files"][f][1] + "</a>";
				else
					row.insertCell(2).innerHTML = "<a onclick='edit_file(\"" + bwd + "/" + result["files"][f][1] +  "\")'>" + result["files"][f][1] + "</a>";
				//else
					//row.insertCell(2).innerHTML = result["files"][f][1];
			}

			/*if(result["files"][f][0]) {
				row.insertCell(3);
				row.insertCell(4);
			}
			else*/ {
				if(result["files"][f][2] < 1000)
					row.insertCell(3).innerHTML = result["files"][f][2] + "b";
				else if(result["files"][f][2] < 1000000)
					row.insertCell(3).innerHTML = (result["files"][f][2]/1000).toFixed(2) + "kb";
				else
					row.insertCell(3).innerHTML = (result["files"][f][2]/1000000).toFixed(2) + "mb";

				row.insertCell(4).innerHTML = result["files"][f][3];
			}
		}

		if(dir != "/") 
		{
			var row = files_table.insertRow(1);
			var par = bwd.substring(0, bwd.lastIndexOf("/"));
			row.insertCell(0).innerHTML = "<input type='checkbox' id='checkbox-parent' disabled style='vertical-align: middle;'>";
			row.insertCell(1).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-folder'></i>";
			row.insertCell(2).innerHTML = "<a href='#' onclick='get_dir(\"" + par + "\")'>../</a>";
			row.insertCell(3);
			row.insertCell(4);
		}
	}

	async function explorer_init() {
		bwd = pwd
	}
</script>