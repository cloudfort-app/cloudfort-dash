<div class="card">
	<span id="span-pwd"></span>
</div><br>

<div class="card">
	<i title="new dir" class='bs-ico bootstrap-folder-plus width-1em ico-link-color' onclick="show_create_dir()"></i> &nbsp;&nbsp;
	<i title="new file" class='bs-ico bootstrap-file-earmark-plus width-1em ico-link-color' onclick="show_create_file()"></i> &nbsp;&nbsp;
	<i title="del path" class='bs-ico bootstrap-trash width-1em ico-link-color' onclick="show_rm_path()"></i> &nbsp;&nbsp;
	<i title="rename" class='bs-ico bootstrap-input-cursor-text width-1em ico-link-color' onclick="show_mv_path()"></i>
</div><br>

<div id="card-input-name" class="card" style="display: none">
	<input id="input-name" placeholder="name">
	<button id="create_dir_button"  class="btn" onclick="create_dir()" style="display: none">create</button>
	<button id="create_file_button" class="btn" onclick="create_file()" style="display: none">create</button>
	<button id="rm_path_button"  class="btn" onclick="rm_path()" style="display: none">delete</button>
</div>

<div id="card-input-rename" class="card" style="display: none">
	<input id="input-name-old" placeholder="path old"> &nbsp;&nbsp;
	<input id="input-name-new" placeholder="path new">
	<button id="mv_path_button"  class="btn" onclick="mv_path()">rename</button>
</div>

<div class="card" id="card-browser">
	<table id="table-files">
		<tr>
			<th></th>
			<th style="margin-right:100px">name</th>
			<th>size</th>
			<th>modified</th>
		</tr>
	</table>
</div>

<style>
	#table-files {
		margin: 0 auto; 
		text-align: left;

		display: block;
		/*height: calc(100vh - 16em);
		overflow-y: scroll;*/
	}

	#card-browser {
		/*height: calc(100vh - 15em);*/
	}
</style>

<script>
	const table = document.getElementById("table-files");
	var bwd = "nil"; //browser working directory

	async function hide_input_cards() {
		document.getElementById("card-input-rename").style.display = "none";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("create_dir_button").style.display = "none";
		document.getElementById("create_file_button").style.display = "none";
		document.getElementById("rm_path_button").style.display = "none";
	}

	async function show_create_dir() {
		if(document.getElementById("create_dir_button").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-name").style.display = "flex";
			document.getElementById("create_dir_button").style.display = "inline-flex";
			document.getElementById("input-name").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_create_file() {
		if(document.getElementById("create_file_button").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-name").style.display = "flex";
			document.getElementById("create_file_button").style.display = "inline-flex";
			document.getElementById("input-name").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_rm_path() {
		if(document.getElementById("rm_path_button").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-name").style.display = "flex";
			document.getElementById("rm_path_button").style.display = "inline-flex";
			document.getElementById("input-name").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function show_mv_path() {
		if(document.getElementById("card-input-rename").style.display == "none") {
			hide_input_cards();
			document.getElementById("card-input-rename").style.display = "flex";
			document.getElementById("input-name-old").focus();
		}
		else {
			hide_input_cards();
		}
	}

	async function create_dir() {
		var dirname = document.getElementById("input-name").value;

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + dirname);

		response = await fetch("/api/dir/create", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.json();

		get_dir(bwd);

		document.getElementById("input-name").value = "";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("create_dir_button").style.display = "none";
	}

	async function create_file() {
		var filename = document.getElementById("input-name").value;

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + filename);

		response = await fetch("/api/file/create", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.json();

		get_dir(bwd);

		document.getElementById("input-name").value = "";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("create_file_button").style.display = "none";
	}

	async function mv_path() {
		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path-old", bwd + "/" + document.getElementById("input-name-old").value);
		formData.append("path-new", bwd + "/" + document.getElementById("input-name-new").value);

		response = await fetch("/api/mv", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.json();

		get_dir(bwd);

		document.getElementById("input-name-old").value = "";
		document.getElementById("input-name-new").value = "";
		document.getElementById("card-input-rename").style.display = "none";
	}

	async function rm_path() {
		var filename = document.getElementById("input-name").value;

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);
		formData.append("path", bwd + "/" + filename);

		response = await fetch("/api/rm", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
			body: formData
		});
		result = await response.json();

		get_dir(bwd);

		document.getElementById("input-name").value = "";
		document.getElementById("card-input-name").style.display = "none";
		document.getElementById("rm_path_button").style.display = "none";
	}

	async function clear_table() {
		while(table.rows.length > 1)
			table.deleteRow(1);
	}

	async function get_dir(dir) {
		clear_table();

		const date = new Date().getTime().toString();
		const formData = new FormData();
		formData.append("date", date);

		bwd = dir;
		document.getElementById("span-pwd").innerHTML = "";
		var dirs = [], files = [];

		var cwd = bwd;
		if(cwd.substring(0, home.length) == home)
			    cwd = "~" + cwd.substring(home.length, cwd.length);

		while(cwd.lastIndexOf("/") >= 0) {
			dirs.push(cwd);
			files.push(cwd.substring(cwd.lastIndexOf('/')+1, cwd.length+1))
			//alert(cwd);
			//alert(cwd.substring(cwd.lastIndexOf('/')+1, cwd.length+1))
			cwd = cwd.substring(0, cwd.lastIndexOf('/'))
		}

		if(cwd == '~')
			document.getElementById("span-pwd").innerHTML += "<a href='#' onclick='get_dir(\"" + home + "\")'>~</a>/"
		else
			document.getElementById("span-pwd").innerHTML += "/"

		for(var i=dirs.length-1; i>=0; --i) {
			document.getElementById("span-pwd").innerHTML += "<a href='#' onclick='get_dir(\"" + dirs[i].replace("~", home) + "\")'>" + files[i] + "</a>/"
		}

		if(dir[0] == '~' && home.length)
			dir = home + dir.substring(1, dir.length);
		else if(dir == "")
			dir = "/";

		formData.append("dir", dir);
		response = await fetch("/api/ls", {
			method: "POST",
			headers: {
				//"content-type": "application/json"
				"signature": signature(date)
		    },
	        body: formData
		});
		result = await response.json();

		for(var f=result["files"].length-1; f>=0; --f) {
			var row = table.insertRow(1);

			if(result["files"][f][0])
				row.insertCell(0).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-folder' style='padding-top: 3px'></i>";
			else 
				row.insertCell(0).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-file-earmark' style='padding-top: 3px'></i>";

			if(result["files"][f][0]) {
				row.insertCell(1).innerHTML = "<a href='#' onclick='get_dir(\"" + bwd + "/" + result["files"][f][1] +  "\")'>" + result["files"][f][1] + "/</a>";
			}
			else {
				row.insertCell(1).innerHTML = "<a href='#' onclick='edit_file(\"" + bwd + "/" + result["files"][f][1] +  "\")'>" + result["files"][f][1] + "</a>";
				//row.insertCell(1).innerHTML = result["files"][f][1];
			}

			if(result["files"][f][0]) {
				row.insertCell(2);
				row.insertCell(3);
			}
			else {
				if(result["files"][f][2] < 1000)
					row.insertCell(2).innerHTML = result["files"][f][2] + "b";
				else if(result["files"][f][2] < 1000000)
					row.insertCell(2).innerHTML = result["files"][f][2]/1000 + "kb";
				else
					row.insertCell(2).innerHTML = result["files"][f][2]/1000000 + "mb";

				row.insertCell(3).innerHTML = result["files"][f][3];
			}
		}

		if(dir != "/") 
		{
			var row = table.insertRow(1);
			var par = bwd.substring(0, bwd.lastIndexOf("/"));
			row.insertCell(0).innerHTML = "<i class='bs-ico ico-white width-1em default-cursor bootstrap-folder'></i>";
			row.insertCell(1).innerHTML = "<a href='#' onclick='get_dir(\"" + par + "\")'>../</a>";
			row.insertCell(2);
			row.insertCell(3);
		}
	}

	async function explorer_init() {
		bwd = await get_pwd();
		get_dir(bwd);
	}
</script>